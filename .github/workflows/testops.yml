name: Testops

on:
  workflow_dispatch:
    inputs:
      ALLURE_JOB_RUN_ID:
        description: service parameter (leave blank)
        required: false
      ENDPOINT:
        description: Endpoint (only for test env info)
        required: false
        default: https://pitneybowes.testops.cloud
      BROWSER:
        description: Browser
        required: false
        default: Opera
      OS:
        description: OS
        required: false
        default: macOS

env:
  ALLURE_ENDPOINT: https://pitneybowes.testops.cloud
  ALLURE_PROJECT_ID: 67
  ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
  ALLURE_JOB_RUN_ID: ${{ github.event.inputs.ALLURE_JOB_RUN_ID }}
  ALLURE_RESULTS: allure-results

jobs:
  autotests:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pytest allure-pytest
          fi
          python - <<'PY'
import pkgutil; print("allure-pytest installed?", bool(pkgutil.find_loader("allure_pytest")))
PY

      - name: Install allurectl
        uses: allure-framework/setup-allurectl@v1
        with:
          allure-endpoint: https://pitneybowes.testops.cloud
          allure-token: ${{ secrets.ALLURE_TOKEN }}
          allure-project-id: 67

      - name: Sanity: pytest collection
        run: pytest --collect-only -q || true

      - name: Run tests with allurectl
        env:
          ENDPOINT: ${{ github.event.inputs.ENDPOINT }}
          BROWSER: ${{ github.event.inputs.BROWSER }}
          OS: ${{ github.event.inputs.OS }}
          ALLURE_JOB_RUN_ID: ${{ github.event.inputs.ALLURE_JOB_RUN_ID }}
          ALLURE_RESULTS: allure-results
          ALLURE_ENDPOINT: https://pitneybowes.testops.cloud
          ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
          ALLURE_PROJECT_ID: "67"
        run: |
          set -euxo pipefail
          allurectl --version
          rm -rf "${ALLURE_RESULTS}"
          allurectl watch \
            --endpoint "${ALLURE_ENDPOINT}" \
            --token "${ALLURE_TOKEN}" \
            --project-id "${ALLURE_PROJECT_ID}" \
            --results "${ALLURE_RESULTS}" \
            --launch-name "GH ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} #${GITHUB_RUN_NUMBER}" \
            -- pytest -q --alluredir="${ALLURE_RESULTS}" --capture=no

      - name: List allure-results after run
        if: always()
        run: |
          ls -la "${ALLURE_RESULTS}" || true
          echo "files: $(ls -1 "${ALLURE_RESULTS}" 2>/dev/null | wc -l)"

      - name: Upload allure-results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
          if-no-files-found: warn

      - name: Fallback upload to TestOps (debug)
        if: always()
        env:
          ALLURE_ENDPOINT: https://pitneybowes.testops.cloud
          ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
          ALLURE_PROJECT_ID: "67"
        run: |
          if [ -d "allure-results" ] && [ "$(ls -1 allure-results | wc -l)" -gt 0 ]; then
            set -euxo pipefail
            allurectl upload \
              --endpoint "${ALLURE_ENDPOINT}" \
              --token "${ALLURE_TOKEN}" \
              --project-id "${ALLURE_PROJECT_ID}" \
              --results "allure-results" \
              --launch-name "GH ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} #${GITHUB_RUN_NUMBER} (fallback)" \
              --debug
          else
            echo "No allure-results to upload."
          fi
